<template>
    <!-- 漏洞信息 - 结构化列表 -->
    <div class="vulnerability-list">
        <div class="rounded-3 border border-solid border-[#E6E6E666] p-6 bg-[#F2F2F280]">
            <!-- 漏洞列表 -->
            <div v-if="listData && listData.length > 0" class="vuln-items">
                <!-- 默认显示前3个漏洞，按严重程度排序 -->
                <div v-for="(vuln, index) in displayedVulnerabilities" :key="vuln.vuln_id || index"
                     class="vuln-item flex items-center justify-between group">
                    <div>
                        <!-- 漏洞基本信息行 -->
                        <div class="vuln-header flex items-center mb-[8px]">
                            <div class="flex items-center gap-[10px] flex-1">
                                <!-- 漏洞等级标签 - 移到标题前面 -->
                                <span class="severity-tag flex-shrink-0"
                                      :style="{
                                          backgroundColor: getDangerLevel(vuln.severity).bgc,
                                          color: getDangerLevel(vuln.severity).color
                                      }">
                                    {{ getDangerLevel(vuln.severity).text }}
                                </span>

                                <!-- 漏洞名称 -->
                                <span class="vuln-title text-[15px] font-medium text-[#262626] cursor-pointer hover:text-[#6C87FF] hover:underline flex-1"
                                      @click="openVulnDetailModal(vuln)">
                                    {{ vuln.title || '未知漏洞' }}
                                </span>
                            </div>

                            <!-- 报告链接 -->
                            <!-- <div v-if="vuln.report_url" class="report-link ml-[16px] flex-shrink-0">
                                <a @click="openReportUrl(vuln.report_url)" class="text-[13px] text-[#6C87FF] flex items-center cursor-pointer">
                                    报告链接
                                    <svg class="ml-[4px]" width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z" fill="#6C87FF"/>
                                    </svg>
                                </a>
                            </div> -->
                        </div>

                        <!-- 漏洞次要信息行 -->
                        <div class="vuln-meta flex items-center text-[13px] text-[#8c8c8c]">
                            <div class="meta-item flex items-center">
                                <!-- <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px]">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="#909090"/>
                                </svg> -->
                                <span>类型：{{ vuln.vulnerability_type || '未知' }}</span>
                            </div>
                            <span class="meta-separator"></span>

                            <div class="meta-item flex items-center">
                                <!-- <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px]">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z" fill="#909090"/>
                                </svg> -->
                                <span>状态：{{ VULN_STATUS_OPTION.find(item => item.value === vuln.status)?.label || '未知' }}</span>
                            </div>
                            <span class="meta-separator"></span>

                            <div class="meta-item flex items-center">
                                <!-- <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px]">
                                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" fill="#909090"/>
                                </svg> -->
                                <span>安全能力：{{ vuln.security_capability_name || '未知' }}</span>
                            </div>
                            <span class="meta-separator"></span>

                            <div class="meta-item flex items-center">
                                <!-- <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px]">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z" fill="#909090"/>
                                </svg> -->
                                <span>创建时间：{{ formatDate(vuln.created_at) }}</span>
                            </div>

                            <!-- 查看详情按钮 - 点击打开弹窗 -->
                            <div class="flex-1"></div>
                        </div>
                    </div>
                    <!-- v-if="vuln.similar_vuln_unique_id" -->
                    <div v-if="vuln.similar_vuln_unique_id"  @click="aggregationModalOpen=true; mergeVulns=vuln"
                         class="aggregation-button flex items-center gap-[4px] px-[9px] py-[3px] rounded-[3px] cursor-pointer"
                         style="background: linear-gradient(270deg, rgba(108, 135, 255, 0.05) 0%, rgba(178, 115, 255, 0.05) 100%);
 border: 1px solid; border: 1px solid rgba(178, 115, 255, 0.2)">
                        <!-- 聚合图标 -->
                        <div class="icon-container flex items-center justify-center" style="width: 18px; height: 18px;">
                            <svg width="14" height="14" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 1px;">
                                <path d="M14.3 7.69999L9.90001 6.04999L14.3 4.39834L15.95 0L17.6016 4.39834L22 6.04999L17.6016 7.69999L15.95 12.1L14.3 7.69999ZM5.49997 16.5L0 14.3L5.49997 12.1L7.69999 6.60001L9.90001 12.1L15.4 14.3L9.90001 16.5L7.69999 22L5.49997 16.5Z" fill="url(#paint0_linear_priority_figma)"/>
                                <defs>
                                    <linearGradient id="paint0_linear_priority_figma" x1="22" y1="11" x2="0" y2="11" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#B273FF"/>
                                        <stop offset="1" stop-color="#6C87FF"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <!-- 文字 -->
                        <span style="font-family: 'PingFang SC', sans-serif; display: flex; justify-content: space-between; font-weight: 500; font-size: 15px; line-height: 1.5em; background: linear-gradient(270deg, #6C87FF 0%, #B273FF 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            漏洞聚合分析
                        </span>
                    </div>
                </div>

                <!-- 渐进式披露控制 -->
                <div v-if="listData.length > defaultVulnCount" class="toggle-vulns mt-[16px] mb-[10px]">
                    <a v-if="!showAllVulns"
                       @click="showAllVulns = true"
                       class="toggle-link flex items-center text-[13px] text-[#6C87FF] cursor-pointer">
                        <svg class="mr-[4px]" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6-1.41-1.41z" fill="#6C87FF"/>
                        </svg>
                        查看全部 {{ listData.length }} 个漏洞
                    </a>
                    <a v-else
                       @click="showAllVulns = false"
                       class="toggle-link flex items-center text-[13px] text-[#6C87FF] cursor-pointer">
                        <svg class="mr-[4px]" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z" fill="#6C87FF"/>
                        </svg>
                        收起漏洞列表
                    </a>
                </div>

                <!-- 分页控件 -->
                <div v-if="listData.length > 10" class="pagination-container flex justify-end mt-[20px]">
                    <a-pagination :show-total="total => `共 ${total.toLocaleString()} 条`"
                                  show-quick-jumper :total=pageConfig.total @change="changePageHandle"
                                  v-model:current="pageConfig.current" v-model:pageSize="filters.limit" />
                </div>
            </div>

            <!-- 无数据展示 -->
            <div v-else class="no-data-container py-[24px] text-center">
                <svg class="inline-block mb-[8px]" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="#bfbfbf"/>
                </svg>
                <div class="text-[14px] text-[#606266]">暂无漏洞信息</div>
            </div>
        </div>

        <!-- 漏洞上下文信息弹窗 -->
        <VulnerabilityContextInformation
            v-model:open="openVulnerabilityContextInformation"
            v-if="openVulnerabilityContextInformation"
            :PropData="PropData" />

        <!-- 漏洞详情弹窗 -->
        <a-modal
            v-model:visible="vulnDetailModalVisible"
            :title="null"
            width="840px"
            :footer="null"
            :destroyOnClose="true"
            class="vuln-detail-modal"
        >
            <div class="vuln-detail-content">
                <!-- 漏洞标题头部 -->
                <div class="vuln-detail-header pt-[16px] pb-[14px] border-b border-[#f0f0f0]">
                    <div class="flex items-center gap-[8px] relative">
                        <!-- 漏洞等级标签 - 移到标题前面 -->
                        <span class="severity-tag flex-shrink-0 flex items-center justify-center" :style="getSeverityClass(currentVuln?.severity)">
                            {{ getSeverityText(currentVuln?.severity) }}
                        </span>

                        <!-- 漏洞标题 -->
                        <h3 class="text-[15px] font-medium text-[#1f2329] flex-1 leading-[20px] my-0">
                            {{ currentVuln?.title || '未知漏洞' }}
                        </h3>

                        <div @click="turnOnLog" class="text-button-gray absolute right-[22px] top-[-22px]">
                            <Svg height="14px" width="14px" name="log"></Svg>
                            <span>操作日志</span>
                        </div>
                    </div>

                    <!-- 漏洞元数据信息 -->
                    <div class="vuln-meta flex flex-wrap items-center text-[12px] text-[#606266] mt-[10px] gap-y-[6px]">
                        <div v-if="currentVuln?.vulnerability_type" class="meta-item flex items-center max-w-full pr-[12px]">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px] flex-shrink-0">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="#909090"/>
                            </svg>
                            <span class="truncate">类型：{{ currentVuln?.vulnerability_type || '未知' }}</span>
                        </div>
                        <span v-if="currentVuln?.vulnerability_type && currentVuln?.status" class="meta-separator">·</span>

                        <div v-if="currentVuln?.status" class="meta-item flex items-center pr-[12px]">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px] flex-shrink-0">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z" fill="#909090"/>
                            </svg>
                            <span>状态：{{ VULN_STATUS_OPTION.find(item => item.value === currentVuln?.status)?.label || '未知' }}</span>
                        </div>
                        <span v-if="currentVuln?.status && currentVuln?.security_capability_name" class="meta-separator">·</span>

                        <div v-if="currentVuln?.security_capability_name" class="meta-item flex items-center pr-[12px]">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px] flex-shrink-0">
                                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" fill="#909090"/>
                            </svg>
                            <span>安全能力：{{ currentVuln?.security_capability_name || '未知' }}</span>
                        </div>
                        <span v-if="currentVuln?.security_capability_name && currentVuln?.created_at" class="meta-separator">·</span>

                        <div v-if="currentVuln?.created_at" class="meta-item flex items-center pr-[12px]">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-[4px] flex-shrink-0">
                                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z" fill="#909090"/>
                            </svg>
                            <span>创建时间：{{ formatDate(currentVuln?.created_at) }}</span>
                        </div>

                        <!-- 如果有报告链接，显示在这里 -->
                        <div v-if="currentVuln?.report_url" class="flex-1"></div>
                        <div  v-if="currentVuln?.report_url" class="report-link flex-shrink-0">
                            <span @click="openReportUrl(currentVuln.report_url)" class="text-[12px] text-[#6C87FF] flex items-center cursor-pointer hover:text-purple-100">
                                报告链接
                                <!-- <svg class="ml-[4px]" width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z" fill="#6C87FF"/>
                                </svg> -->
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 内容区域 -->
                <div class="vuln-detail-body">
                    <!-- 详情部分 - 使用选项卡导航 -->
                    <a-tabs default-active-key="1" class="vuln-tabs">
                        <!-- 漏洞详情选项卡 -->
                        <a-tab-pane key="1" tab="漏洞详情">
                            <!-- 基本信息 -->
                            <div class="detail-section mb-[20px]" v-if="hasBasicInfo">
                                <h4 class="section-title mb-[12px]">基本信息</h4>
                                <div class="info-grid grid grid-cols-1 md:grid-cols-2 gap-[12px]">
                                    <div class="info-item" v-if="currentVuln?.cwe_id">
                                        <div class="info-label text-[12px] text-[#606266] mb-[4px]">CWE ID</div>
                                        <div class="info-value text-[13px] text-[#303133] leading-[1.5]">{{ currentVuln.cwe_id }}</div>
                                    </div>
                                    <div class="info-item" v-if="currentVuln?.cve_id">
                                        <div class="info-label text-[12px] text-[#606266] mb-[4px]">CVE 编号</div>
                                        <div class="info-value text-[13px] text-[#303133] leading-[1.5]">{{ currentVuln.cve_id }}</div>
                                    </div>
                                    <div class="info-item" v-if="currentVuln?.vuln_identifiers && currentVuln.vuln_identifiers.length">
                                        <div class="info-label text-[12px] text-[#606266] mb-[4px]">其他编号</div>
                                        <div class="info-value text-[13px] text-[#303133] leading-[1.5]">
                                            <div v-for="(id, index) in currentVuln.vuln_identifiers" :key="index" class="vuln-id">
                                                {{ id.type }}({{ id.id }})
                                            </div>
                                        </div>
                                    </div>
                                    <div class="info-item" v-if="currentVuln?.tags && currentVuln.tags.length">
                                        <div class="info-label text-[12px] text-[#606266] mb-[4px]">标签</div>
                                        <div class="info-value text-[13px] tags-container">
                                            <a-tag v-for="(tag, index) in currentVuln.tags.slice(0, 3)" :key="index" class="tag-item">
                                                {{ tag }}
                                            </a-tag>
                                            <a-popover v-if="currentVuln.tags.length > 3">
                                                <template #content>
                                                    <div class="tag-popover-content">
                                                        <a-tag v-for="tag in currentVuln.tags.slice(3)" :key="tag" class="tag-item">{{ tag }}</a-tag>
                                                    </div>
                                                </template>
                                                <a-tag class="tag-item">+{{ currentVuln.tags.length - 3 }}</a-tag>
                                            </a-popover>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CVSS评估 -->
                            <div v-if="currentVuln?.cvss && currentVuln.cvss.length" class="detail-section mb-[20px]">
                                <h4 class="section-title mb-[12px]">CVSS评估</h4>
                                <a-table
                                    class="cvss-table"
                                    :pagination="false"
                                    :loading="{ indicator, spinning: loading }"
                                    :columns="expand_columns"
                                    :scroll="{ x: '100%' }"
                                    :data-source="currentVuln.cvss"
                                >
                                    <template #emptyText>
                                        <Empty />
                                    </template>
                                </a-table>
                            </div>

                            <!-- 漏洞描述 -->
                            <div class="detail-section mb-[24px]">
                                <h4 class="section-title">漏洞描述</h4>
                                <div class="description-content mt-[16px]">
                                    <MarkDown :text="currentVuln?.description || '暂无漏洞描述'" />
                                </div>
                            </div>

                            <!-- 漏洞影响 -->
                            <div v-if="currentVuln?.impact" class="detail-section mb-[24px]">
                                <h4 class="section-title">漏洞影响</h4>
                                <div class="impact-content mt-[16px]">
                                    {{ currentVuln.impact }}
                                </div>
                            </div>
                        </a-tab-pane>

                        <!-- 修复方案选项卡 -->
                        <a-tab-pane key="2" tab="修复方案" v-if="currentVuln?.solution && currentVuln.solution.length">
                            <div class="solution-items">
                                <div v-for="(item, index) in currentVuln.solution" :key="index" class="solution-item mb-[24px]">
                                    <div class="solution-header flex items-center mb-[12px]">
                                        <a-tag class="mr-[8px]">{{ item.type }}</a-tag>
                                        <span class="solution-title text-[15px] font-medium">{{ item.details || '' }}</span>
                                    </div>
                                    <div class="solution-content bg-[#f8f9fa] p-[16px] rounded-[4px]">
                                        <MarkDown :text="item.description || '暂无详细修复方案'" />
                                    </div>
                                </div>
                            </div>
                        </a-tab-pane>

                        <!-- 漏洞上下文选项卡，仅在有数据时显示 -->
                        <a-tab-pane key="3" tab="漏洞上下文">
                            <div v-if="!currentVuln?.context || currentVuln.context.length === 0" class="empty-context-tips">
                                <div class="text-center py-[24px] text-[#606266]">
                                    <svg class="inline-block mb-[8px]" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="#bfbfbf"/>
                                    </svg>
                                    <div class="text-[14px]">暂无漏洞上下文信息</div>
                                </div>
                            </div>
                            <VulnerabilityContextInformation
                                v-else
                                :PropData="currentVuln.context"
                                :is-in-tab="true"
                            />
                        </a-tab-pane>

                        <!-- 参考链接选项卡，仅在有数据时显示 -->
                        <a-tab-pane key="4" tab="参考链接" v-if="currentVuln?.reference && currentVuln.reference.length">
                            <div class="reference-items">
                                <div v-for="(item, index) in currentVuln.reference" :key="index" class="reference-item py-[8px]">
                                    <a :href="item.url" target="_blank" class="reference-link text-[#6C87FF] hover:underline">
                                        {{ item.url }}
                                    </a>
                                </div>
                            </div>
                        </a-tab-pane>
                    </a-tabs>
                </div>
            </div>
        </a-modal>

        <OperationLogModal v-model:open="opetateLog" v-if="opetateLog" :logfilter="logfilter" />

        <AggregationModal v-model:open="aggregationModalOpen" :mergeVulns="mergeVulns" v-if="aggregationModalOpen" />
    </div>
</template>

<script setup>
import {
    reactive, ref, computed, watch,
} from 'vue';
import { indicator, formatDate, getDangerLevel } from 'utils';
import { getSecVulnListApi } from 'api/app';
import { usePageList } from '@/hooks';
import AggregationModal from './AggregationModal.vue';
import { VULN_STATUS_OPTION } from '@/constants/app';
import VulnerabilityContextInformation from './VulnerabilityContextInformation.vue';

const openVulnerabilityContextInformation = ref(false);
const PropData = ref([]);
const aggregationModalOpen = ref(false);
const mergeVulns = ref({});

const { issue_id } = defineProps(['issue_id']);
const emit = defineEmits(['update-total']);

const filters = reactive({
    issue_id: Number(issue_id),
});

const {
    listData, loading, pageConfig,
} = usePageList(getSecVulnListApi, filters);

// 监听pageConfig.total变化并emit给父组件
watch(() => pageConfig.total, (newTotal) => {
    emit('update-total', newTotal);
}, { immediate: true });

// 漏洞详情弹窗相关
const vulnDetailModalVisible = ref(false);
const currentVuln = ref(null);

const opetateLog = ref(false);
const logfilter = ref({
    entity_type: 'Vuln',
    entity_id: null, // 这里可以根据实际情况设置
});
// 开启操作日志
const turnOnLog = () => {
    opetateLog.value = true;
    logfilter.value.entity_id = String(currentVuln.value.vuln_id);
};

// 计算属性 - 判断是否有基本信息可显示
const hasBasicInfo = computed(() => currentVuln.value?.cwe_id
    || currentVuln.value?.cve_id
    || (currentVuln.value?.vuln_identifiers && currentVuln.value.vuln_identifiers.length > 0)
    || (currentVuln.value?.tags && currentVuln.value.tags.length > 0));

// 打开漏洞详情弹窗
const openVulnDetailModal = (vuln) => {
    currentVuln.value = vuln;
    // 预先设置上下文数据
    PropData.value = vuln.context || [];
    vulnDetailModalVisible.value = true;
};

// 获取等级显示文本
const getSeverityText = (severity) => getDangerLevel(severity).text;

// 获取等级样式类
const getSeverityClass = (severity) => {
    const levelInfo = getDangerLevel(severity);
    return {
        backgroundColor: levelInfo.bgc,
        color: levelInfo.color,
    };
};

// 渐进式披露控制
const defaultVulnCount = 3; // 默认显示前3个漏洞
const showAllVulns = ref(false);

// 排序后的漏洞列表，按严重程度降序排列
const sortedVulnerabilities = computed(() => {
    if (!listData.value || listData.value.length === 0) {
        return [];
    }

    // 定义严重程度优先级
    const severityOrder = {
        critical: 0,
        high: 1,
        medium: 2,
        low: 3,
        unknown: 4,
    };

    // 返回按严重程度排序的数组
    return [...listData.value].sort((a, b) => {
        const aSeverity = a.severity?.toLowerCase() || 'unknown';
        const bSeverity = b.severity?.toLowerCase() || 'unknown';
        return severityOrder[aSeverity] - severityOrder[bSeverity];
    });
});

// 要显示的漏洞列表
const displayedVulnerabilities = computed(() => {
    if (showAllVulns.value || sortedVulnerabilities.value.length <= defaultVulnCount) {
        return sortedVulnerabilities.value;
    }
    return sortedVulnerabilities.value.slice(0, defaultVulnCount);
});

// 保留原有列和信息项定义（仅供参考，不再使用表格）
const expand_columns = ref([
    {
        title: 'CVSS版本',
        dataIndex: 'version',
        width: 100,
        fixed: 'left',
    },
    {
        title: 'CVSS评分',
        dataIndex: 'score',
        width: 100,
    },
    {
        title: 'CVSS向量',
        dataIndex: 'vector',
        width: 'auto',
    },
]);

// 打开报告链接
const openReportUrl = (url) => {
    if (url) {
        window.open(url, '_blank');
    }
};

// 分页函数
const changePageHandle = (page) => {
    pageConfig.current = page;
};
</script>

<style lang="scss" scoped>
.vulnerability-list {
    width: 100%;
}

.vuln-item {
    border-radius: 6px;
    position: relative;
    padding: 16px 24px;
    background-color: #fff;
}

.vuln-item:not(:last-child) {
    margin-bottom: 16px;
}

.vuln-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 600px;
}

.meta-separator {
    margin: 0 8px;
    color: #c0c4cc;
}
.aggregation-button:hover {
    background: linear-gradient(270deg, rgba(108, 135, 255, 0.15) 0%, rgba(178, 115, 255, 0.15) 100%) !important;
}

.meta-item {
    display: flex;
    align-items: center;
    white-space: nowrap;
}

.vuln-meta {
    color: #606266;
}

.meta-item svg path {
    fill: #909090;
}

/* 漏洞等级标签样式 */
.severity-tag {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    color: white;
}

.severity-critical {
    background-color: #cf1322;
}

.severity-high {
    background-color: #f5222d;
}

.severity-medium {
    background-color: #fa8c16;
}

.severity-low {
    background-color: #faad14;
}

/* 图标颜色样式 */
.vuln-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #606266;
}

.icon-critical {
    color: rgba(207, 19, 34, 0.8);
}

.icon-high {
    color: rgba(245, 34, 45, 0.8);
}

.icon-medium {
    color: rgba(250, 140, 22, 0.8);
}

.icon-low {
    color: rgba(250, 173, 20, 0.8);
}

/* 原有展开内容样式 */
.expand-content {
    background-color: #F2F2F280;
    display: flex;
    flex-direction: column;
    gap: 32px;
    padding: 11px 20px;
}

.expand-content .item {
        display: flex;
        flex-direction: column;
        gap: 16px;
}

.expand-content .title {
    color: #303133;
            font-size: 16px;
            font-weight: 500;
        }

.expand-content .value {
            background-color: #fff;
            border-radius: 4px;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 32px;
}

.expand-content .value_item {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

.expand-content .solution_item {
                display: flex;
                flex-direction: column;
                gap: 12px;
}

.info_list {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
}

.info_list .info_item {
        width: calc((100% - 48px)/4);
        min-height: 48px;
        display: flex;
        flex-direction: column;
        gap: 4px;
}

.info_list .info_item .edit-svg {
            height: 24px;
            width: 24px;
            display: flex;
            padding: 4px;
            border-radius: 4px;
}

.info_list .info_item .edit-svg:hover {
                background-color: #e6e6e6;
            }

.info_list .info_item .label {
            font-size: 12px;
    color: #606266;
            font-weight: 400;
            line-height: 20px;
            display: flex;
            gap: 4px;
        }

.info_list .info_item .value {
            font-size: 14px;
    color: #303133;
            font-weight: 400;
            line-height: 22px;
            padding: 1px 0px;
            gap: 10px;
}

.text-button-blue {
    color: #6C87FF;
    cursor: pointer;
}

.title_with_line {
    display: flex;
    align-items: center;
    gap: 8px;
}

.title_with_line .line {
    width: 4px;
    height: 16px;
    background-color: #6C87FF;
    border-radius: 2px;
}

.title_with_line .content {
    font-size: 16px;
    font-weight: 500;
    color: #303133;
}

/* 无数据状态样式 */
.no-data-container {
    color: #606266;
}

/* 弹窗样式 */
:deep(.vuln-detail-modal .ant-modal-body) {
    padding: 0;
    max-height: 80vh;
    overflow-y: auto;
}

.vuln-detail-content {
    padding: 0;
}

// 漏洞详情弹窗样式
:deep(.vuln-detail-modal) {
  .ant-modal-content {
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .ant-modal-close {
    color: rgba(0, 0, 0, 0.45);

    &:hover {
      color: rgba(0, 0, 0, 0.75);
    }
  }

  .ant-modal-body {
    padding: 0;
  }

  .vuln-detail-content {
    .vuln-detail-header {
      background-color: #fff;

      .severity-tag {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 1px 8px;
        border-radius: 2px;
        font-size: 12px;
        font-weight: 500;
        color: white;
        line-height: 18px;
        height: 20px;
      }

      .meta-separator {
        margin: 0 4px;
        color: #d9d9d9;
      }

      .meta-item {
        display: flex;
        align-items: center;
        white-space: nowrap;

        &.max-w-full {
          max-width: 100%;

          span {
            text-overflow: ellipsis;
            overflow: hidden;
          }
        }
      }
    }

    .vuln-detail-body {
      .vuln-tabs {
        :deep(.ant-tabs-nav) {
          margin-bottom: 0;
          padding: 0 24px;

          .ant-tabs-tab-btn {
            font-size: 13px;
          }
        }

        :deep(.ant-tabs-tab) {
          padding: 8px 0;
          margin-right: 24px;
        }

        :deep(.ant-tabs-ink-bar) {
          height: 2px;
        }

        :deep(.ant-tabs-content-holder) {
          .ant-tabs-content {
            .ant-tabs-tabpane {
              padding: 24px;
            }
          }
        }
      }

      :deep(.ant-collapse-header) {
        font-size: 13px;
      }

      :deep(.ant-tag) {
        font-size: 12px;
        padding: 0 4px;
        line-height: 1.5;
        margin-right: 6px;
        margin-bottom: 4px;
        height: 20px;

        &.tag-item {
          margin-right: 4px;
          margin-bottom: 4px;
          font-size: 12px;
          padding: 0 4px;
          line-height: 18px;
        }
      }

      :deep(.ant-collapse-content) {
        font-size: 13px;
      }

      :deep(.ant-empty-description) {
        font-size: 13px;
      }

      .section-title {
        font-size: 14px;
        font-weight: 500;
        color: #1f2329;
        position: relative;
        margin-bottom: 0;
      }

      .info-item {
        padding: 8px 10px;
        border-radius: 4px;
        background: #f8f9fa;

        .info-label {
          color: #606266;
          font-size: 12px;
          margin-bottom: 4px;
          font-weight: normal;
        }

        .info-value {
          font-size: 13px;
          color: #303133;
          line-height: 1.5;

          .vuln-id {
            margin-bottom: 3px;

            &:last-child {
              margin-bottom: 0;
            }
          }
        }
      }

      .cvss-table {
        border: 1px solid #f0f0f0;
        border-radius: 2px;

        :deep(.ant-table-thead > tr > th) {
          background-color: #f8f9fa;
          padding: 8px 12px;
          font-size: 12px;
          font-weight: normal;
          color: #606266;
        }

        :deep(.ant-table-tbody > tr > td) {
          padding: 8px 12px;
          font-size: 12px;
        }
      }

      .solution-content {
        :deep(p) {
          margin-bottom: 12px;
          font-size: 13px;

          &:last-child {
            margin-bottom: 0;
          }
        }
      }

      .reference-item {
        border-bottom: 1px solid #f0f0f0;

        &:last-child {
          border-bottom: none;
        }

        a {
          font-size: 13px;
        }
      }

      .solution-header {
        .solution-title {
          font-size: 13px;
        }
      }

      .description-content, .impact-content {
        font-size: 13px;
        line-height: 1.5;
        color: #434343;
      }
    }
  }
}

// 让上下文弹窗适配选项卡环境
:deep(.vuln-context-in-tab) {
  padding: 0 !important;

  .ant-modal-content {
    box-shadow: none !important;
  }

  .ant-modal-body {
    padding: 0 !important;
  }

  .context-item {
    font-size: 13px;
  }

  :deep(.ant-collapse-header) {
    font-size: 13px;
  }

  :deep(.context-label) {
    font-size: 12px;
  }
}

.tag-popover-content {
  max-width: 300px;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

// 确保所有MarkDown内容字体一致
:deep(.markdown-body) {
  font-size: 13px !important;
  line-height: 1.5;

  h1, h2, h3, h4, h5, h6 {
    font-size: 14px !important;
    margin-top: 10px;
    margin-bottom: 10px;
    font-weight: 500;
  }

  p {
    font-size: 13px !important;
    margin-bottom: 10px;
    line-height: 1.5;
  }

  ul, ol {
    font-size: 13px !important;
    padding-left: 20px;
    margin-bottom: 10px;
  }

  li {
    font-size: 13px !important;
    line-height: 1.5;
    margin-bottom: 4px;
  }

  code, pre {
    font-size: 12px !important;
    font-family: Consolas, Monaco, 'Courier New', monospace;
  }

  table {
    font-size: 12px !important;
    margin-bottom: 10px;

    th, td {
      padding: 6px 8px;
      border: 1px solid #eee;
    }

    th {
      background-color: #f8f9fa;
      font-weight: normal;
    }
  }

  blockquote {
    font-size: 13px !important;
    color: #606266;
    border-left: 3px solid #ddd;
    padding-left: 10px;
    margin: 10px 0;
  }
}

// 确保所有弹窗内弹性菜单的样式一致
:deep(.ant-popover) {
  .ant-popover-inner-content {
    padding: 8px;
    max-height: 300px;
    overflow-y: auto;
  }
}

/* 查看详情按钮样式 */
.vuln-actions {
    a {
        padding: 4px 10px;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        background-color: #fafafa;

        &:hover {
            background-color: #f0f0f0;
        }
    }
}
</style>
