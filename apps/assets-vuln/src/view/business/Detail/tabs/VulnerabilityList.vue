<template>
    <!-- 漏洞信息 -->
    <div class=" flex gap-[24px] bg-white ">
        <div class="table_container w-full" >
            <a-table class="base-table" :pagination="false"  :loading="{ indicator, spinning: loading }" :columns="columns"
                     :scroll="{ x: '100%' }" :data-source="listData" :row-key="(record) => record.vuln_id || new Date().getTime()">
                <template #emptyText>
                    <Empty />
                </template>
                <template #bodyCell="{ column, text }">

                    <template v-if="column.dataIndex === 'severity'">
                        <SecIssueLevel :text />
                    </template>

                    <template v-if="column.dataIndex === 'title' || column.dataIndex === 'vulnerability_type'">
                        <a-tooltip arrowPointAtCenter>
                            <template #title>{{ text }}</template>
                            <span class="w-full ellipsis">
                                {{ text || '-' }}
                            </span>
                        </a-tooltip>
                    </template>

                    <template v-if="column.dataIndex === 'report_url'">
                        <span class="ellipsis hover" @click="openReportUrl(text)">{{ text || '-' }}</span>
                    </template>

                    <template v-if="column.dataIndex === 'created_at' || column.dataIndex === 'updated_at'">
                        {{ formatDate(text) }}
                    </template>

                    <!-- <template v-if="column.dataIndex === 'status'">

                    </template> -->

                </template>

                <template #expandedRowRender="{ record }">
                    <div class="expand-content">
                        <div class="item">
                            <span class="title">漏洞详情</span>
                            <div class="value">
                                <div class="value_item">
                                    <div class="title_with_line">
                                        <div class="line"></div>
                                        <span class="content">基本信息</span>
                                    </div>

                                    <div class="info_list">

                                        <div class="info_item" v-for="item in basic_information_title" :key="item.label">
                                            <span class="label">{{ item.label }}</span>
                                            <span class="value">
                                                <div v-if="item.value === 'tags'">
                                                    <a-tag>{{ record[item.value]?.[0] || '-' }}</a-tag>

                                                    <a-popover v-if="record[item.value]?.length >1">
                                                        <template #content>
                                                            <a-tag v-for="item in record[item.value].slice(1)" :key="item">{{ item}}</a-tag>
                                                        </template>
                                                        <a-tag>+{{ record[item.value].length-1}}</a-tag>
                                                    </a-popover>
                                                </div>

                                                <a-tooltip arrowPointAtCenter v-else-if="item.value === 'vuln_identifiers'">
                                                    <template #title>
                                                        <div v-for="(id, index) in record[item.value]" :key="index">
                                                            {{ id.type }}({{ id.id }})
                                                        </div>
                                                    </template>
                                                    <span class="ellipsis">
                                                        <div v-for="(id, index) in record[item.value]" :key="index">
                                                            {{ id.type }}({{ id.id }})
                                                        </div>
                                                    </span>
                                                </a-tooltip>

                                                <a-tooltip arrowPointAtCenter v-else>
                                                    <template #title>{{ record[item.value] || '-' }}</template>
                                                    <span class="ellipsis">{{ record[item.value] || '-' }}</span>
                                                </a-tooltip>
                                            </span>
                                        </div>

                                    </div>
                                </div>
                                <div class="value_item">
                                    <div class="title_with_line">
                                        <div class="line"></div>
                                        <span class="content">CVSS评估</span>
                                    </div>
                                    <a-table class="base-table" :pagination="false"  :loading="{ indicator, spinning: loading }" :columns="expand_columns"
                                             :scroll="{ x: '100%' }" :data-source="record.cvss">
                                        <template #emptyText>
                                            <Empty />
                                        </template>
                                    </a-table>
                                </div>
                                <div class="value_item">
                                    <div class="title_with_line">
                                        <div class="line"></div>
                                        <span class="content">漏洞描述</span>
                                    </div>
                                    <span>{{ record.description || '-' }}</span>
                                </div>
                                <div class="value_item">
                                    <div class="title_with_line">
                                        <div class="line"></div>
                                        <span class="content">漏洞影响</span>
                                    </div>
                                    <span>{{ record.impact || '-' }}</span>
                                </div>
                                <div class="text-button-blue">
                                    <span>查看详情</span>
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <span class="title">修复方案</span>
                            <div class="value">
                                <div class="solution_item" v-for="item in record.solution" :key="item">
                                    <div class="flex flex-row">
                                        <a-tag>{{ item.type }}</a-tag>
                                        {{ item.details || '-' }}
                                    </div>
                                    <div class="flex flex-row bg-gray-50 px-6 py-4">
                                        {{ item.description || '-' }}
                                    </div>

                                </div>

                            </div>
                        </div>
                        <div class="item">
                            <span class="title">参考链接</span>
                            <div class="value">
                                <div class="flex flex-row" v-for="item in record.reference" :key="item">
                                    <span class="ellipsis hover" @click="openReportUrl(item.url)">{{ item.url || '-' }}</span>
                                </div>

                            </div>
                        </div>
                    </div>
                </template>

            </a-table>

            <div class="flex justify-end mt-4">
                <a-pagination :show-total="total => `共 ${total.toLocaleString()} 条`"
                              show-quick-jumper :total=pageConfig.total  @change="changePageHandle"
                              v-model:current="pageConfig.current" v-model:pageSize="filters.limit" />

            </div>
        </div>

    </div>
</template>

<script setup>
import { reactive, ref } from 'vue';
import { indicator, formatDate } from 'utils';
import { getSecVulnListApi } from 'api/app';
import { usePageList } from '@/hooks';

const { issue_id } = defineProps(['issue_id']);

const filters = reactive({
    issue_id,
});

const {
    listData, loading, pageConfig,
} = usePageList(getSecVulnListApi, filters);

console.log(listData.value);

const columns = ref([
    {
        title: '漏洞名称',
        dataIndex: 'title',
        width: 280,
        fixed: 'left',
    },
    {
        title: '漏洞级别',
        dataIndex: 'severity',
        width: 120,
    },
    {
        title: '漏洞类型',
        dataIndex: 'vulnerability_type',
        width: 178,
    },
    {
        title: '安全能力',
        dataIndex: 'security_capability_name',
        width: 178,
    },
    {
        title: '漏洞状态',
        dataIndex: 'status',
        width: 120,
    },
    {
        title: '报告链接',
        dataIndex: 'report_url',
        width: 280,
    },
    {
        title: '创建时间',
        dataIndex: 'created_at',
        width: 178,
    },
    {
        title: '更新时间',
        dataIndex: 'updated_at',
        width: 178,
    },
]);

const expand_columns = ref([
    {
        title: 'CVSS版本',
        dataIndex: 'version',
        width: 280,
        fixed: 'left',
    },
    {
        title: 'CVSS评分',
        dataIndex: 'score',
        width: 120,
    },
    {
        title: 'CVSS向量',
        dataIndex: 'vector',
        width: 178,
    },

]);

const basic_information_title = [
    { label: 'CWE ID', value: 'cwe_id' },
    { label: 'CVE 编号', value: 'cve_id' },
    { label: '其他编号', value: 'vuln_identifiers' },
    { label: '标签', value: 'tags' },
];

</script>

<style scoped>

.expand-content {

    background-color: #F2F2F280;
    display: flex;
    flex-direction: column;
    gap: 32px;
    padding: 11px 20px;

    .item {
        display: flex;
        flex-direction: column;
        gap: 16px;

        .title {
            color: #3C3C3C;
            font-size: 16px;
            font-weight: 500;
        }

        .value {
            background-color: #fff;
            border-radius: 4px;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;

            .value_item{
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .solution_item{
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
        }
    }
}

.info_list{
    display: flex;
    flex-wrap: wrap;
    gap: 16px;

    .info_item {
        width: calc((100% - 48px)/4);
        min-height: 48px;
        display: flex;
        flex-direction: column;
        gap: 4px;

        .edit-svg{
            height: 24px;
            width: 24px;
            display: flex;
            padding: 4px;
            border-radius: 4px;

            &:hover{
                background-color: #e6e6e6;
            }

        }

        .label {
            font-size: 12px;
            color: #999999;
            font-weight: 400;
            line-height: 20px;
            display: flex;
            gap: 4px;
        }

        .value {
            font-size: 14px;
            color: #3C3C3C;
            font-weight: 400;
            line-height: 22px;
            padding: 1px 0px;
            gap: 10px;
            /* white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; */
        }
    }
}
</style>
